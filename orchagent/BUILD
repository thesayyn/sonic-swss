package(default_visibility = ["//visibility:public"])

DEFAULT_DEFINES = [
    "DRAIN_MMU_WHEN_APPLYING_BUFFER_CONFIG",
]

DEBUG_COPTS = select({
    "//:debug_mode": ["-ggdb -DDEBUG"],
    "//conditions:default": ["-g -DNDEBUG"],
})

filegroup(
    name = "orchagent_srcs",
    srcs = [
        "aclorch.cpp",
        "bfdorch.cpp",
        "bufferorch.cpp",
        "cbf/cbfnhgorch.cpp",
        "cbf/nhgmaporch.cpp",
        "chassisorch.cpp",
        "copporch.cpp",
        "countercheckorch.cpp",
        "crmorch.cpp",
        "dash/dashorch.cpp",
        "dash/dashrouteorch.cpp",
        "dash/dashvnetorch.cpp",
        "dash/dashaclorch.cpp",
        "dash/dashaclgroupmgr.cpp",
        "dash/dashtagmgr.cpp",
        "dash/pbutils.cpp",
        "debug_counter/debug_counter.cpp",
        "debug_counter/drop_counter.cpp",
        "debugcounterorch.cpp",
        "dtelorch.cpp",
        "fabricportsorch.cpp",
        "fdborch.cpp",
        "fgnhgorch.cpp",
        "flex_counter/flex_counter_manager.cpp",
        "flex_counter/flex_counter_stat_manager.cpp",
        "flex_counter/flow_counter_handler.cpp",
        "flex_counter/flowcounterrouteorch.cpp",
        "flexcounterorch.cpp",
        "intfsorch.cpp",
        "isolationgrouporch.cpp",
        "lagid.cpp",
        "macsecorch.cpp",
        "mirrororch.cpp",
        "mlagorch.cpp",
        "mplsrouteorch.cpp",
        "muxorch.cpp",
        "natorch.cpp",
        "neighorch.cpp",
        "nhgbase.cpp",
        "nhgorch.cpp",
        "notifications.cpp",
        "nvgreorch.cpp",
        "orch.cpp",
        "orchdaemon.cpp",
        "p4orch/acl_rule_manager.cpp",
        "p4orch/acl_table_manager.cpp",
        "p4orch/acl_util.cpp",
        "p4orch/ext_tables_manager.cpp",
        "p4orch/gre_tunnel_manager.cpp",
        "p4orch/l3_admit_manager.cpp",
        "p4orch/mirror_session_manager.cpp",
        "p4orch/neighbor_manager.cpp",
        "p4orch/next_hop_manager.cpp",
        "p4orch/p4oidmapper.cpp",
        "p4orch/p4orch.cpp",
        "p4orch/p4orch_util.cpp",
        "p4orch/route_manager.cpp",
        "p4orch/router_interface_manager.cpp",
        "p4orch/tables_definition_manager.cpp",
        "p4orch/wcmp_manager.cpp",
        "pbh/pbhcap.cpp",
        "pbh/pbhcnt.cpp",
        "pbh/pbhmgr.cpp",
        "pbh/pbhrule.cpp",
        "pbhorch.cpp",
        "pfcactionhandler.cpp",
        "pfcwdorch.cpp",
        "policerorch.cpp",
        "port/port_capabilities.cpp",
        "port/porthlpr.cpp",
        "portsorch.cpp",
        "qosorch.cpp",
        "request_parser.cpp",
        "response_publisher.cpp",
        "routeorch.cpp",
        "saiattr.cpp",
        "saihelper.cpp",
        "sfloworch.cpp",
        "srv6orch.cpp",
        "switch/switch_capabilities.cpp",
        "switch/switch_helper.cpp",
        "switchorch.cpp",
        "tunneldecaporch.cpp",
        "twamporch.cpp",
        "vnetorch.cpp",
        "vrforch.cpp",
        "vxlanorch.cpp",
        "watermarkorch.cpp",
        "zmqorch.cpp",
    ],
)

filegroup(
    name = "orchagent_hdrs",
    srcs = [
        "aclorch.h",
        "acltable.h",
        "bfdorch.h",
        "bufferorch.h",
        "bulker.h",
        "cbf/cbfnhgorch.h",
        "cbf/nhgmaporch.h",
        "chassisorch.h",
        "copporch.h",
        "countercheckorch.h",
        "crmorch.h",
        "dash/dashorch.h",
        "dash/dashrouteorch.h",
        "dash/dashvnetorch.h",
        "dash/dashaclorch.h",
        "dash/dashaclgroupmgr.h",
        "dash/dashtagmgr.h",
        "dash/pbutils.h",
        "dash/taskworker.h",
        "debug_counter/debug_counter.h",
        "debug_counter/drop_counter.h",
        "debug_counter/drop_reasons.h",
        "debugcounterorch.h",
        "directory.h",
        "dtelorch.h",
        "fabricportsorch.h",
        "fdborch.h",
        "fgnhgorch.h",
        "flex_counter/flex_counter_manager.h",
        "flex_counter/flex_counter_stat_manager.h",
        "flex_counter/flow_counter_handler.h",
        "flex_counter/flowcounterrouteorch.h",
        "flexcounterorch.h",
        "intfsorch.h",
        "isolationgrouporch.h",
        "label.h",
        "lagid.h",
        "macsecorch.h",
        "mirrororch.h",
        "mlagorch.h",
        "muxorch.h",
        "natorch.h",
        "neighorch.h",
        "nexthopgroupkey.h",
        "nexthopkey.h",
        "nhgbase.h",
        "nhgorch.h",
        "notifications.h",
        "notifier.h",
        "nvgreorch.h",
        "observer.h",
        "orch.h",
        "orchdaemon.h",
        "p4orch/acl_rule_manager.h",
        "p4orch/acl_table_manager.h",
        "p4orch/acl_util.h",
        "p4orch/ext_tables_manager.h",
        "p4orch/gre_tunnel_manager.h",
        "p4orch/l3_admit_manager.h",
        "p4orch/mirror_session_manager.h",
        "p4orch/neighbor_manager.h",
        "p4orch/next_hop_manager.h",
        "p4orch/object_manager_interface.h",
        "p4orch/p4oidmapper.h",
        "p4orch/p4orch.h",
        "p4orch/p4orch_util.h",
        "p4orch/route_manager.h",
        "p4orch/router_interface_manager.h",
        "p4orch/tables_definition_manager.h",
        "p4orch/wcmp_manager.h",
        "pbh/pbhcap.h",
        "pbh/pbhcnt.h",
        "pbh/pbhmgr.h",
        "pbh/pbhrule.h",
        "pbh/pbhschema.h",
        "pbhorch.h",
        "pfcactionhandler.h",
        "pfcwdorch.h",
        "policerorch.h",
        "port.h",
        "port/port_capabilities.h",
        "port/portcnt.h",
        "port/porthlpr.h",
        "port/portschema.h",
        "portsorch.h",
        "qosorch.h",
        "request_parser.h",
        "response_publisher.h",
        "response_publisher_interface.h",
        "return_code.h",
        "routeorch.h",
        "saiattr.h",
        "saihelper.h",
        "sfloworch.h",
        "srv6orch.h",
        "switch/switch_capabilities.h",
        "switch/switch_container.h",
        "switch/switch_helper.h",
        "switch/switch_schema.h",
        "switchorch.h",
        "swssnet.h",
        "timer.h",
        "tunneldecaporch.h",
        "twamporch.h",
        "vnetorch.h",
        "vrforch.h",
        "vxlanorch.h",
        "watermarkorch.h",
        "zmqorch.h",
    ],
)

cc_library(
    name = "orchagent_lib",
    srcs = [],
    hdrs = [":orchagent_hdrs"],
    copts = [
        "-I/usr/include/sai",
        "-fno-stack-protector",
    ] + DEBUG_COPTS,
    defines = [
        "DRAIN_MMU_WHEN_APPLYING_BUFFER_CONFIG",
    ],
    linkopts = ["-lpthread", "-lprotobuf"],
    local_defines = DEFAULT_DEFINES,
    deps = [
        "//bazel/saimetadata:saimeta",
        "//bazel/saimetadata:saimetadata",
        "//bazel/swsscommon:swsscommon",
        "//bazel/zmq:zmq",
        "//bazel/dashapi:dashapi",
    ],
)

cc_library(
    name = "orchagent_lib_impl",
    srcs = [
        ":orchagent_srcs",
        "//lib:lib_utils_srcs",
    ],
    hdrs = [":orchagent_hdrs"],
    copts = [
        "-fno-stack-protector",
    ] + DEBUG_COPTS,
    linkopts = ["-lpthread", "-lprotobuf"],
    local_defines = DEFAULT_DEFINES,
    deps = [
        "//bazel/hiredis:hiredis",
        "//bazel/libnl3:libnl-genl-3",
        "//bazel/libnl3:libnl-nf-3",
        "//bazel/libnl3:libnl-route-3",
        "//bazel/libnl3:libnl3",
        "//bazel/saimetadata:saimeta",
        "//bazel/saimetadata:saimetadata",
        "//bazel/sairedis:sairedis",
        "//bazel/swsscommon:swsscommon",
        "//bazel/zmq:zmq",
        "//bazel/dashapi:dashapi",
        "//bazel/dashapi:dashapi_proto",
    ],
)

cc_binary(
    name = "orchagent",
    srcs = [
        "main.cpp",
    ],
    copts = [
        "-fno-stack-protector",
    ] + DEBUG_COPTS,
    linkopts = ["-lpthread"],
    local_defines = DEFAULT_DEFINES,
    deps = [
        ":orchagent_lib_impl",
    ],
)

# todo(lmeninato): split into smaller test targets
filegroup(
    name = "p4orch_tests_srcs",
    srcs = [
        "copporch.cpp",
        "flex_counter/flex_counter_manager.cpp",
        "flex_counter/flow_counter_handler.cpp",
        "notifications.cpp",
        "orch.cpp",
        "p4orch/acl_rule_manager.cpp",
        "p4orch/acl_table_manager.cpp",
        "p4orch/acl_util.cpp",
        "p4orch/ext_tables_manager.cpp",
        "p4orch/gre_tunnel_manager.cpp",
        "p4orch/l3_admit_manager.cpp",
        "p4orch/mirror_session_manager.cpp",
        "p4orch/neighbor_manager.cpp",
        "p4orch/next_hop_manager.cpp",
        "p4orch/p4oidmapper.cpp",
        "p4orch/p4orch.cpp",
        "p4orch/p4orch_util.cpp",
        "p4orch/route_manager.cpp",
        "p4orch/router_interface_manager.cpp",
        "p4orch/tables_definition_manager.cpp",
        "p4orch/tests/acl_manager_test.cpp",
        "p4orch/tests/fake_consumerstatetable.cpp",
        "p4orch/tests/fake_crmorch.cpp",
        "p4orch/tests/fake_dbconnector.cpp",
        "p4orch/tests/fake_flexcounterorch.cpp",
        "p4orch/tests/fake_flowcounterrouteorch.cpp",
        "p4orch/tests/fake_notificationconsumer.cpp",
        "p4orch/tests/fake_portorch.cpp",
        "p4orch/tests/fake_producertable.cpp",
        "p4orch/tests/fake_subscriberstatetable.cpp",
        "p4orch/tests/fake_table.cpp",
        "p4orch/tests/gre_tunnel_manager_test.cpp",
        "p4orch/tests/l3_admit_manager_test.cpp",
        "p4orch/tests/mirror_session_manager_test.cpp",
        "p4orch/tests/mock_sai_acl.cpp",
        "p4orch/tests/mock_sai_hostif.cpp",
        "p4orch/tests/mock_sai_router_interface.cpp",
        "p4orch/tests/mock_sai_serialize.cpp",
        "p4orch/tests/mock_sai_switch.cpp",
        "p4orch/tests/mock_sai_udf.cpp",
        "p4orch/tests/neighbor_manager_test.cpp",
        "p4orch/tests/next_hop_manager_test.cpp",
        "p4orch/tests/p4oidmapper_test.cpp",
        "p4orch/tests/p4orch_util_test.cpp",
        "p4orch/tests/return_code_test.cpp",
        "p4orch/tests/route_manager_test.cpp",
        "p4orch/tests/router_interface_manager_test.cpp",
        "p4orch/tests/test_main.cpp",
        "p4orch/tests/wcmp_manager_test.cpp",
        "p4orch/wcmp_manager.cpp",
        "port/port_capabilities.cpp",
        "request_parser.cpp",
        "switch/switch_capabilities.cpp",
        "switch/switch_helper.cpp",
        "switchorch.cpp",
        "vrforch.cpp",
        "vxlanorch.cpp",
        "zmqorch.cpp",
    ] + glob([
        "p4orch/tests/*.h",
    ]),
)

cc_test(
    name = "p4orch_tests",
    srcs = [
        ":p4orch_tests_srcs",
    ],
    copts = select({
        "//:asan": [
            "-fsanitize=address",
            "-DASAN_ENABLED",
        ],
        "//:tsan": [
            "-fsanitize=thread",
        ],
        "//:usan": [
            "-fsanitize=undefined",
        ],
        "//conditions:default": [],
    }) + DEBUG_COPTS,
    data = [
        "//cfgmgr:confg_mgr_data",
    ],
    linkopts = ["-lpthread", "-lprotobuf"] + select({
        "//:asan": ["-lasan"],
        "//conditions:default": [],
    }),
    local_defines = DEFAULT_DEFINES,
    deps = [
        ":orchagent_lib",
        "//tests/mock_tests:fake_response_publisher_lib",
        "@com_google_googletest//:gtest",
        "@com_google_googletest//:gtest_main",
        "//bazel/hiredis:hiredis",
        "//bazel/saimetadata:saimeta",
        "//bazel/saimetadata:saimetadata",
        "//bazel/sairedis:sairedis",
        "//bazel/swsscommon:swsscommon",
        "//bazel/zmq:zmq",
        "//bazel/dashapi:dashapi",
    ] + select({
        "//:asan": [
            "//lib:asan",
        ],
        "//conditions:default": [],
    }),
)

filegroup(
    name = "orchagent_data",
    srcs = [
        "eliminate_events.lua",
        "lagids.lua",
        "pfc_detect_barefoot.lua",
        "pfc_detect_broadcom.lua",
        "pfc_detect_cisco-8000.lua",
        "pfc_detect_innovium.lua",
        "pfc_detect_marvell.lua",
        "pfc_detect_mellanox.lua",
        "pfc_detect_nephos.lua",
        "pfc_detect_vs.lua",
        "pfc_restore.lua",
        "pfc_restore_cisco-8000.lua",
        "port_rates.lua",
        "rif_rates.lua",
        "trap_rates.lua",
        "tunnel_rates.lua",
        "watermark_bufferpool.lua",
        "watermark_pg.lua",
        "watermark_queue.lua",
    ],
)

cc_binary(
    name = "routeresync",
    srcs = ["routeresync.cpp"],
    copts = DEBUG_COPTS,
    # TODO BL: I don't think we need these linkopts, we already depend on them
    # linkopts = ["-lhiredis -lswsscommon"],
    local_defines = DEFAULT_DEFINES,
    deps = [
        "//bazel/hiredis:hiredis",
        "//bazel/swsscommon:swsscommon",
    ],
)

cc_binary(
    name = "orchagent_restart_check",
    srcs = ["orchagent_restart_check.cpp"],
    copts = DEBUG_COPTS,
    linkopts = ["-lpthread"],
    local_defines = DEFAULT_DEFINES,
    deps = [
        "//bazel/hiredis:hiredis",
        "//bazel/swsscommon:swsscommon",
    ],
)

cc_library(
    name = "response_publisher_lib",
    srcs = ["response_publisher.cpp"],
    hdrs = [
        "response_publisher.h",
        "response_publisher_interface.h",
        "return_code.h",
    ],
    copts = [
        "-Wno-sign-compare",
        "-fno-stack-protector",
    ] + select({
        "//:debug_mode": ["-ggdb -DDEBUG"],
        "//conditions:default": ["-g -DNDEBUG"],
    }),
    deps = [
        "//bazel/hiredis:hiredis",
        "//bazel/libnl3:libnl-genl-3",
        "//bazel/libnl3:libnl-route-3",
        "//bazel/libnl3:libnl3",
        "//bazel/saimetadata:saimeta",
        "//bazel/saimetadata:saimetadata",
        "//bazel/saivs:saivs",
        "//bazel/swsscommon:swsscommon",
        "//bazel/zmq:zmq",
        "//lib:lib_utils",
    ],
)

cc_library(
    name = "mock_response_publisher_lib",
    srcs = [],
    hdrs = [
        "p4orch/tests/mock_response_publisher.h",
    ],
    deps = [
        ":orchagent_lib",
    ],
)

cc_library(
    name = "request_parser_lib",
    srcs = ["request_parser.cpp"],
    copts = DEBUG_COPTS,
    deps = [
        "//orchagent:orchagent_lib",
        "//lib:lib_utils",
    ],
)

# ----------- Libraries to export for other targets -----------------
cc_library(
    name = "orchagent_test_lib",
    srcs = [
        "aclorch.cpp",
        "bfdorch.cpp",
        "bufferorch.cpp",
        "cbf/cbfnhgorch.cpp",
        "cbf/nhgmaporch.cpp",
        "chassisorch.cpp",
        "copporch.cpp",
        "countercheckorch.cpp",
        "crmorch.cpp",
        "dash/dashorch.cpp",
        "dash/dashrouteorch.cpp",
        "dash/dashvnetorch.cpp",
        "dash/dashaclorch.cpp",
        "dash/dashaclgroupmgr.cpp",
        "dash/dashtagmgr.cpp",
        "dash/pbutils.cpp",
        "debug_counter/debug_counter.cpp",
        "debug_counter/drop_counter.cpp",
        "debugcounterorch.cpp",
        "dtelorch.cpp",
        "fabricportsorch.cpp",
        "fdborch.cpp",
        "fgnhgorch.cpp",
        "flex_counter/flex_counter_manager.cpp",
        "flex_counter/flex_counter_stat_manager.cpp",
        "flex_counter/flow_counter_handler.cpp",
        "flex_counter/flowcounterrouteorch.cpp",
        "flexcounterorch.cpp",
        "intfsorch.cpp",
        "isolationgrouporch.cpp",
        "lagid.cpp",
        "macsecorch.cpp",
        "mirrororch.cpp",
        "mlagorch.cpp",
        "mplsrouteorch.cpp",
        "muxorch.cpp",
        "natorch.cpp",
        "neighorch.cpp",
        "nhgbase.cpp",
        "nhgorch.cpp",
        "notifications.cpp",
        "nvgreorch.cpp",
        "orch.cpp",
        "orchdaemon.cpp",
        "p4orch/acl_rule_manager.cpp",
        "p4orch/acl_table_manager.cpp",
        "p4orch/acl_util.cpp",
        "p4orch/ext_tables_manager.cpp",
        "p4orch/gre_tunnel_manager.cpp",
        "p4orch/l3_admit_manager.cpp",
        "p4orch/mirror_session_manager.cpp",
        "p4orch/neighbor_manager.cpp",
        "p4orch/next_hop_manager.cpp",
        "p4orch/p4oidmapper.cpp",
        "p4orch/p4orch.cpp",
        "p4orch/p4orch_util.cpp",
        "p4orch/route_manager.cpp",
        "p4orch/router_interface_manager.cpp",
        "p4orch/tables_definition_manager.cpp",
        # TODO BL: This file doesn't exist
        # "p4orch/tests/mock_component_state_helper.h",
        "p4orch/tests/mock_response_publisher.h",
        "p4orch/tests/mock_sai_switch.cpp",
        "p4orch/tests/mock_sai_switch.h",
        "p4orch/wcmp_manager.cpp",
        "pbh/pbhcap.cpp",
        "pbh/pbhcnt.cpp",
        "pbh/pbhmgr.cpp",
        "pbh/pbhrule.cpp",
        "pbhorch.cpp",
        "pfcactionhandler.cpp",
        "pfcwdorch.cpp",
        "policerorch.cpp",
        "port/port_capabilities.cpp",
        "port/porthlpr.cpp",
        "portsorch.cpp",
        "qosorch.cpp",
        "request_parser.cpp",
        "routeorch.cpp",
        "saiattr.cpp",
        "saihelper.cpp",
        "sfloworch.cpp",
        "srv6orch.cpp",
        "switch/switch_capabilities.cpp",
        "switch/switch_helper.cpp",
        "switchorch.cpp",
        "tunneldecaporch.cpp",
        "twamporch.cpp",
        "vnetorch.cpp",
        "vrforch.cpp",
        "vxlanorch.cpp",
        "watermarkorch.cpp",
        "zmqorch.cpp",
    ],
    copts = [
        "-Wno-sign-compare",
        "-fno-stack-protector",
    ] + select({
        "//:debug_mode": ["-ggdb -DDEBUG"],
        "//conditions:default": ["-g -DNDEBUG"],
    }),
    defines = [
        "DRAIN_MMU_WHEN_APPLYING_BUFFER_CONFIG",
    ],
    deps = [
        ":orchagent_lib",
        "//lib:lib_utils",
        "@com_google_googletest//:gtest",
    ],
)
